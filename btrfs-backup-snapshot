#!/bin/bash

# © 2015 Sebastián González
# http://www.apache.org/licenses/LICENSE-2.0

this=$(realpath "$0")
scripts=$(dirname "$this")

source "$scripts/btrfs-backup-lib.sh"

usage() {
    cat >&2 <<EOF
Usage: $script <subvol> <pool>

Takes a read-only snapshot of subvolume <subvol>.
Stores the snapshot in <pool>.

Example: $script / /var/backup
EOF
    exit 1
}

(( $# == 2 )) || usage
subvol=$1
pool=$2

[ -d "$subvol" ] || die "Source subvolume $subvol must be a directory"
[ -d "$pool" ] || die "Snapshot pool $pool must be a directory"

# Atomic actions.
{
    flock 42

    # Verify that snapshot pool exists (mount if necessary).
    bringUp "$pool"

    name=$(now)
    btrfs subvolume snapshot -r "$subvol" "$pool/$name" > /dev/null
    echo "Created read-only snapshot $name of $subvol in $pool"

} 42>"$pool/$lockfile"
