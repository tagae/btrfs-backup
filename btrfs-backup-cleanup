#!/bin/bash

# Â© 2015 Sebastian Gonzalez
# http://www.apache.org/licenses/LICENSE-2.0

this=$(realpath "$0" || echo "Please install GNU coreutils" >&2)
scripts=$(dirname "$this")

source "$scripts/btrfs-backup-lib.sh"

usage() {
    cat >&2 <<EOF
Usage: $script <pool>

Removes old backups from snapshot pool <pool>.

Example: $script /var/backup/home
EOF
    exit 1
}

(( $# == 1 )) || usage
pool=$1

use-pool "$pool"

now=$(now)
day=${now%% *}
month=${day%-*}
year=${month%-*}

day() {
    find "$pool" -maxdepth 1 -type d -name "$day*"
}

monthButDay() {
    find "$pool" -maxdepth 1 -type d -name "$month*" -not -name "$day*"
}

yearButMonth() {
    find "$pool" -maxdepth 1 -type d -name "$year*" -not -name "$month*"
}

deleteSnapshots() {
    count=0
    while read snapshot
    do
        btrfs subvolume delete "$snapshot" > /dev/null
        echo "Removed snapshot $snapshot"
        count=$((count+1))
    done
    if ((count > 0)); then
        echo "Cleaned up $count snapshots in $pool"
    fi
}

monthButLastInDay() {
    { monthButDay
      monthButDay | sort --reverse | sort --unique --key=1,1
    } | sort | uniq --unique
}

# Delete all but last of each day in the month.
monthButLastInDay | deleteSnapshots
